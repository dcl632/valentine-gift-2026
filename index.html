<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Code of Love üíñ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Dancing+Script:wght@400;700&family=Noto+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --pink: #ff6b9d;
            --deep-pink: #e84393;
            --soft-pink: #fd79a8;
            --purple: #a29bfe;
            --dark: #0a0a0f;
            --darker: #060608;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans', sans-serif;
            background: var(--darker);
            color: #e0e0e0;
            -webkit-tap-highlight-color: transparent;
        }

        /* ========== SCROLLABLE MAIN ========== */
        #mainScroll {
            display: none;
            width: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            scroll-snap-type: y proximity;
        }

        #mainScroll.show {
            display: block;
        }

        .section {
            min-height: 100vh;
            min-height: 100dvh;
            width: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            scroll-snap-align: start;
            overflow: hidden;
        }

        /* Floating hearts removed for cleaner look */

        /* ========== PHASE 0: LOCK SCREEN ========== */
        #lockScreen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(160deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.8s ease, transform 0.8s ease;
        }

        #lockScreen.hidden {
            opacity: 0;
            transform: scale(1.1);
            pointer-events: none;
        }

        .lock-time {
            font-size: clamp(64px, 16vw, 110px);
            font-weight: 300;
            letter-spacing: -3px;
            color: #fff;
            text-shadow: 0 0 50px rgba(255, 107, 157, 0.35);
        }

        .lock-date {
            font-size: clamp(14px, 3vw, 17px);
            color: rgba(255, 255, 255, 0.6);
            margin-top: 4px;
            margin-bottom: 55px;
            font-weight: 300;
        }

        /* Heart row removed */

        .gift-box-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }

        .gift-box {
            font-size: 68px;
            animation: giftBounce 2s ease-in-out infinite;
            filter: drop-shadow(0 0 25px rgba(255, 107, 157, 0.5));
            transition: transform 0.3s;
        }

        @keyframes giftBounce {
            0%, 100% { transform: translateY(0) rotate(-3deg); }
            50%      { transform: translateY(-14px) rotate(3deg); }
        }

        .hold-text {
            margin-top: 16px;
            font-size: 15px;
            color: var(--pink);
            font-weight: 400;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.45; }
            50%      { opacity: 1; }
        }

        .hold-progress {
            width: 180px;
            height: 3px;
            background: rgba(255, 255, 255, 0.12);
            border-radius: 2px;
            margin-top: 14px;
            overflow: hidden;
        }

        .hold-progress-fill {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--pink), var(--purple));
            border-radius: 2px;
            transition: width 0.1s linear;
        }

        /* ========== PHASE 1: CODE EDITOR ========== */
        #editorPhase {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            background: var(--darker);
        }

        #editorPhase.show {
            display: flex;
        }

        #editorContainer {
            width: 92%;
            max-width: 660px;
            background: #1e1e2e;
            border-radius: 14px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(255,255,255,0.05);
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.8s ease;
        }

        #editorContainer.show { opacity: 1; }

        #editorContainer.glitch-out {
            animation: glitchOut 0.8s ease forwards;
        }

        @keyframes glitchOut {
            0%   { transform: scale(1); filter: none; }
            20%  { transform: skewX(5deg) scale(1); filter: hue-rotate(90deg); }
            40%  { transform: skewX(-3deg) scale(1.02); filter: hue-rotate(180deg) brightness(1.5); }
            60%  { transform: skewX(2deg) scale(0.98); filter: hue-rotate(270deg); }
            80%  { transform: scale(1.05); filter: brightness(3) saturate(0); opacity: 0.5; }
            100% { transform: scale(0); filter: brightness(5); opacity: 0; }
        }

        .editor-header {
            background: #181825;
            padding: 13px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .editor-dot { width: 12px; height: 12px; border-radius: 50%; }
        .dot-red    { background: #f38ba8; }
        .dot-yellow { background: #f9e2af; }
        .dot-green  { background: #a6e3a1; }

        .editor-title {
            margin-left: 12px;
            font-family: 'Fira Code', monospace;
            font-size: 12px;
            color: #585b70;
        }

        .editor-body {
            padding: 18px 20px;
            min-height: 260px;
            background: #1e1e2e;
            font-family: 'Fira Code', monospace;
        }

        .code-line {
            display: flex;
            gap: 16px;
            margin-bottom: 5px;
            font-size: clamp(11.5px, 2.4vw, 14.5px);
            line-height: 1.75;
        }

        .line-number { color: #45475a; user-select: none; min-width: 24px; text-align: right; }
        .code-content { flex: 1; white-space: pre-wrap; word-break: break-word; }

        .keyword  { color: #cba6f7; }
        .variable { color: #89b4fa; }
        .string   { color: #a6e3a1; }
        .number   { color: #fab387; }
        .comment  { color: #585b70; font-style: italic; }
        .function { color: #f9e2af; }
        .operator { color: #cdd6f4; }

        .blinking-cursor {
            display: inline-block;
            width: 2px; height: 15px;
            background: #cdd6f4;
            animation: blink 1s step-end infinite;
            vertical-align: text-bottom;
            margin-left: 1px;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .terminal {
            background: #11111b;
            padding: 12px 16px;
            margin-top: 14px;
            border-radius: 8px;
            font-size: 11.5px;
            font-family: 'Fira Code', monospace;
            display: none;
            border: 1px solid rgba(255,255,255,0.03);
        }

        .terminal.show { display: block; animation: fadeIn 0.3s ease; }
        .terminal-line { margin-bottom: 5px; color: #a6adc8; }
        .terminal-line .prompt { color: #a6e3a1; }
        .progress-bar { display: flex; align-items: center; gap: 10px; margin-top: 6px; }
        .progress-fill { color: #94e2d5; }
        .build-success { color: #a6e3a1; margin-top: 8px; display: flex; align-items: center; gap: 6px; }

        /* ========== SECTION 1: HEART CANVAS ========== */
        #heartSection {
            background: radial-gradient(ellipse at 50% 45%, #1a0520 0%, #0a0510 40%, var(--darker) 70%);
        }

        #canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
        }

        .scroll-hint {
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 13px;
            color: rgba(255,255,255,0.35);
            animation: bounceDown 2s ease-in-out infinite;
            z-index: 10;
            text-align: center;
        }

        .scroll-hint span {
            display: block;
            font-size: 20px;
            margin-top: 4px;
        }

        @keyframes bounceDown {
            0%, 100% { transform: translateX(-50%) translateY(0); opacity: 0.35; }
            50%      { transform: translateX(-50%) translateY(8px); opacity: 0.7; }
        }

        /* ========== SECTION 2: PHOTO GALLERY ========== */
        #photoSection {
            background: linear-gradient(180deg, var(--darker) 0%, #110a1a 50%, var(--darker) 100%);
            padding: 60px 0;
            min-height: 100vh;
            justify-content: flex-start;
            padding-top: 10vh;
        }

        .gallery-title {
            font-size: clamp(22px, 5vw, 32px);
            font-weight: 300;
            color: rgba(255,255,255,0.85);
            margin-bottom: 8px;
            text-align: center;
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.8s ease, transform 0.8s ease;
        }

        .gallery-title.show {
            opacity: 1;
            transform: translateY(0);
        }

        .gallery-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.4);
            margin-bottom: 40px;
            text-align: center;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.8s ease 0.2s, transform 0.8s ease 0.2s;
        }

        .gallery-subtitle.show {
            opacity: 1;
            transform: translateY(0);
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 14px;
            width: 88%;
            max-width: 420px;
            padding: 0 10px;
        }

        .photo-card {
            background: rgba(255, 255, 255, 0.06);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transform: translateY(40px) scale(0.95);
            transition: opacity 0.7s ease, transform 0.7s ease;
        }

        .photo-card.show {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        .photo-card:nth-child(2) { transition-delay: 0.15s; }
        .photo-card:nth-child(3) { transition-delay: 0.3s; }
        .photo-card:nth-child(4) { transition-delay: 0.45s; }

        .photo-card img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            display: block;
        }

        .photo-card .caption {
            padding: 10px 12px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.55);
            text-align: center;
        }

        /* ========== SECTION 3: CHAT MESSAGE ========== */
        #chatSection {
            background: linear-gradient(180deg, var(--darker) 0%, #0d0a16 50%, var(--darker) 100%);
            padding: 40px 0;
            min-height: 100vh;
            justify-content: center;
        }

        .chat-wrapper {
            width: 90%;
            max-width: 440px;
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.8s ease, transform 0.8s ease;
        }

        .chat-wrapper.show {
            opacity: 1;
            transform: translateY(0);
        }

        .chat-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            margin-bottom: 12px;
            background: rgba(255, 255, 255, 0.06);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.08);
        }

        .chat-avatar {
            width: 42px; height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--pink), var(--purple));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 0 18px rgba(255, 107, 157, 0.25);
            flex-shrink: 0;
            overflow: hidden;
            padding: 0;
        }

        .chat-name {
            font-weight: 600;
            font-size: 15px;
            color: rgba(255,255,255,0.9);
        }

        .chat-status {
            font-size: 11.5px;
            color: #a6e3a1;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 1px;
        }

        .chat-status::before {
            content: '';
            width: 6px; height: 6px;
            border-radius: 50%;
            background: #a6e3a1;
        }

        .chat-bubble {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 18px 18px 18px 6px;
            border: 1px solid rgba(255,255,255,0.12);
            padding: 14px 18px;
            margin-bottom: 10px;
            max-width: 88%;
            font-size: 14.5px;
            line-height: 1.6;
            color: rgba(255,255,255,0.92);
            opacity: 0;
            transform: translateY(16px);
            transition: opacity 0.5s ease, transform 0.5s ease;
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
        }

        .chat-bubble.show { opacity: 1; transform: translateY(0); }

        .chat-bubble.sent {
            background: linear-gradient(135deg, var(--deep-pink), var(--pink));
            border-radius: 18px 18px 6px 18px;
            margin-left: auto;
            border: none;
            color: #fff;
        }

        .chat-bubble .typing-dots {
            display: inline-flex;
            gap: 4px;
            padding: 4px 0;
        }

        .chat-bubble .typing-dots span {
            width: 7px; height: 7px;
            border-radius: 50%;
            background: rgba(255,255,255,0.45);
            animation: dotBounce 1.4s ease-in-out infinite;
        }

        .chat-bubble .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .chat-bubble .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes dotBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30%            { transform: translateY(-7px); }
        }

        .chat-time {
            font-size: 10.5px;
            color: rgba(255,255,255,0.45);
            margin-top: 4px;
        }

        .love-text {
            font-weight: 500;
            font-size: 15px;
            line-height: 1.65;
        }

        .love-text-zh {
            font-family: 'Dancing Script', cursive;
            font-size: clamp(22px, 5.5vw, 30px);
            line-height: 1.4;
        }

        /* ========== SECTION 4: FINAL ========== */
        #finalSection {
            background: radial-gradient(ellipse at 50% 40%, #1a0f2e 0%, var(--darker) 70%);
            min-height: 60vh;
            justify-content: center;
        }

        .final-message {
            text-align: center;
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 1s ease, transform 1s ease;
        }

        .final-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        .final-big-heart {
            font-size: 60px;
            animation: heartBeat 1.5s infinite;
            margin-bottom: 20px;
        }

        @keyframes heartBeat {
            0%, 100% { transform: scale(1); }
            15%      { transform: scale(1.15); }
            30%      { transform: scale(1); }
        }

        .final-line {
            font-size: clamp(14px, 3.5vw, 18px);
            color: rgba(255, 255, 255, 0.7);
            font-weight: 300;
            line-height: 1.8;
            padding: 0 30px;
        }

        .final-line strong {
            color: var(--pink);
            font-weight: 500;
        }

        .footer-text {
            margin-top: 40px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.3);
            text-align: center;
        }

        /* ========== CONFETTI ========== */
        .confetti {
            position: fixed;
            top: -15px;
            pointer-events: none;
            z-index: 9999;
        }

        /* ========== UTILITY ========== */
        @keyframes fadeIn {
            from { opacity: 0; } to { opacity: 1; }
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 500px) {
            .gift-box { font-size: 55px; }
            .photo-grid { gap: 10px; width: 92%; }
            .photo-card .caption { padding: 8px 10px; font-size: 11px; }
            .chat-bubble { padding: 12px 15px; font-size: 13.5px; }
            .love-text { font-size: 14px; }
            .love-text-zh { font-size: 20px; }
            .gallery-title { font-size: 22px; }
            .final-big-heart { font-size: 48px; }
        }
    </style>
</head>
<body>

    <!-- ====== PHASE 0: LOCK SCREEN ====== -->
    <div id="lockScreen">
        <div class="lock-time" id="lockTime">21:14</div>
        <div class="lock-date" id="lockDate">ÊòüÊúüÂÖ≠, 2Êúà14Êó•</div>
        <div class="gift-box-wrapper" id="giftBoxWrapper">
            <div class="gift-box" id="giftBox">üéÅ</div>
            <div class="hold-text">Èï∑ÊåâÈñãÂïüÁ¶ÆÁâ© üíù</div>
            <div class="hold-progress">
                <div class="hold-progress-fill" id="holdFill"></div>
            </div>
        </div>
    </div>

    <!-- ====== PHASE 1: CODE EDITOR (floating overlay) ====== -->
    <div id="editorPhase">
        <div id="editorContainer">
            <div class="editor-header">
                <div class="editor-dot dot-red"></div>
                <div class="editor-dot dot-yellow"></div>
                <div class="editor-dot dot-green"></div>
                <div class="editor-title">love_algorithm.js ‚Äî Code of Love</div>
            </div>
            <div class="editor-body">
                <div id="codeOutput"></div>
                <div class="terminal" id="terminal">
                    <div class="terminal-line"><span class="prompt">‚ùØ</span> npm run build:love</div>
                    <div class="terminal-line">Ê≠£Âú®Á∑®Ë≠ØÊàÄÊÑõÊºîÁÆóÊ≥ï...</div>
                    <div class="progress-bar">
                        <span>[<span class="progress-fill" id="progressFill"></span>]</span>
                        <span id="progressPercent" style="color:#94e2d5">0%</span>
                    </div>
                    <div class="build-success" id="buildSuccess" style="display:none;">
                        <span>‚úì</span> Âª∫ÁΩÆÊàêÂäü ‚Äî Ê∫ñÂÇôÈÄ≤ÂÖ•Â¶≥ÁöÑÂøÉ...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ====== SCROLLABLE SECTIONS ====== -->
    <div id="mainScroll">

        <!-- SECTION 1: Particle Heart -->
        <section class="section" id="heartSection">
            <canvas id="canvas"></canvas>
            <div class="scroll-hint" id="scrollHint">
                Âêë‰∏ãÊªëÂãï
                <span>‚Üì</span>
            </div>
        </section>

        <!-- SECTION 2: Photo Gallery -->
        <section class="section" id="photoSection">
            <div class="gallery-title" id="galleryTitle">Our Memories üíï</div>
            <div class="gallery-subtitle" id="gallerySubtitle">ÊØè‰∏ÄÂàªÈÉΩÂÄºÂæóÁèçËóè</div>
            <div class="photo-grid" id="photoGrid">
                <div class="photo-card">
                    <img src="photos/photo1.jpg?v=3" alt="Memory 1">
                    <div class="caption">Á¥ÑÊúÉÂ§ú üé¨</div>
                </div>
                <div class="photo-card">
                    <img src="photos/photo2.jpg?v=2" alt="Memory 2">
                    <div class="caption">ÂÅ∑ÂÅ∑Ë¶™‰∏ÄÂÄã üíã</div>
                </div>
                <div class="photo-card">
                    <img src="photos/photo3.jpg?v=2" alt="Memory 3">
                    <div class="caption">ÊúÄÂñúÊ≠°ÁöÑÁ¨ëÂÆπ üòä</div>
                </div>
                <div class="photo-card">
                    <img src="photos/photo4.jpg?v=2" alt="Memory 4">
                    <div class="caption">ÂêÉË≤®Êó•Â∏∏ üçΩÔ∏è</div>
                </div>
            </div>
        </section>

        <!-- SECTION 3: Chat Messages -->
        <section class="section" id="chatSection">
            <div class="chat-wrapper" id="chatWrapper">
                <div class="chat-header">
                    <div class="chat-avatar"><img src="photos/avatar.jpg" alt="ÊòéËã±" style="width:100%;height:100%;object-fit:cover;border-radius:50%;"></div>
                    <div>
                        <div class="chat-name">ÊòéËã±</div>
                        <div class="chat-status">Á∑ö‰∏ä</div>
                    </div>
                </div>
                <div id="chatMessages"></div>
            </div>
        </section>

        <!-- SECTION 4: Final -->
        <section class="section" id="finalSection">
            <div class="final-message" id="finalMessage">
                <div class="final-big-heart">‚ù§Ô∏è</div>
                <div class="final-line">
                    Happy Valentine's Day<br>
                    <strong>Ë¶™ÊÑõÁöÑ</strong>ÔºåÊàëÊÑõÂ¶≥Áõ¥Âà∞Ê∞∏ÈÅ†
                </div>
                <div class="footer-text">
                    Made with ‚ù§Ô∏è by ÈºéË∂Ö ¬∑ Valentine 2026
                </div>
            </div>
        </section>

    </div>

    <!-- Audio -->
    <audio id="bgMusic" loop>
        <!-- ‚òÖ REPLACE with your romantic music URL ‚òÖ -->
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
    </audio>

    <script>
    (function() {
        'use strict';

        // ===== CODE =====
        const code = [
            { line: 1, tokens: [
                { type:'keyword',text:'const' },{ type:'variable',text:' myWorld' },
                { type:'operator',text:' = ' },{ type:'keyword',text:'new' },
                { type:'function',text:' Life' },{ type:'operator',text:'();' }
            ]},
            { line: 2, tokens: [
                { type:'keyword',text:'const' },{ type:'variable',text:' you' },
                { type:'operator',text:' = ' },{ type:'string',text:'"Â¶≥"' },
                { type:'operator',text:';' },{ type:'comment',text:' // ÊàëÁöÑÂπ∏Á¶è' }
            ]},
            { line: 3, tokens: [] },
            { line: 4, tokens: [
                { type:'keyword',text:'while' },{ type:'operator',text:' (' },
                { type:'variable',text:'alive' },{ type:'operator',text:') {' }
            ]},
            { line: 5, tokens: [
                { type:'operator',text:'  ' },{ type:'variable',text:'myWorld' },
                { type:'operator',text:'.' },{ type:'function',text:'orbit' },
                { type:'operator',text:'(' },{ type:'variable',text:'you' },
                { type:'operator',text:');' }
            ]},
            { line: 6, tokens: [
                { type:'operator',text:'  ' },{ type:'keyword',text:'if' },
                { type:'operator',text:' (' },{ type:'function',text:'near' },
                { type:'operator',text:'(' },{ type:'variable',text:'you' },
                { type:'operator',text:')) {' }
            ]},
            { line: 7, tokens: [
                { type:'operator',text:'     ' },{ type:'variable',text:'heartRate' },
                { type:'operator',text:' += ' },{ type:'number',text:'1000' },
                { type:'operator',text:';' }
            ]},
            { line: 8, tokens: [{ type:'operator',text:'  }' }] },
            { line: 9, tokens: [{ type:'operator',text:'}' }] },
            { line: 10, tokens: [{ type:'comment',text:'// Ê≠£Âú®Á∑®Ë≠ØÊÑõÊÑè...' }] }
        ];

        const chatSequence = [
            { type:'received', text:'Âª∫ÁΩÆÂÆåÊàê ‚úì' },
            { type:'received', text:'ÂàùÂßãÂåñÊÑõÂøÉÊ®°ÁµÑ... üíó' },
            { type:'received', text:'‚ù§Ô∏è ÊÑõÂøÉÂ∑≤ÈÉ®ÁΩ≤ÔºÅ' },
            { type:'sent', text:'ÈÄôÊòØÊàëË¶™ÊâãÁÇ∫Â¶≥ÂØ´ÁöÑÁ®ãÂºèÔºåÂ∞àÂ±¨ÊñºÂ¶≥ ‚ù§Ô∏è', isLove:true, lang:'zh' },
            { type:'sent', text:'Â¶≥ÊòØÊàë‰∏ñÁïåÁöÑ‰∏≠ÂøÉ üíï', isLove:true, lang:'zh' },
        ];

        // ===== DOM =====
        const $ = id => document.getElementById(id);
        const lockScreen = $('lockScreen');
        const holdFill = $('holdFill');
        const editorPhase = $('editorPhase');
        const editorContainer = $('editorContainer');
        const codeOutput = $('codeOutput');
        const terminal = $('terminal');
        const mainScroll = $('mainScroll');
        const canvas = $('canvas');
        const ctx = canvas.getContext('2d');
        const chatWrapper = $('chatWrapper');
        const chatMessages = $('chatMessages');
        const bgMusic = $('bgMusic');

        let hasStarted = false;
        let holdTimer = null;
        let holdProgress = 0;

        // ===== CLOCK =====
        function updateClock() {
            const n = new Date();
            $('lockTime').textContent = String(n.getHours()).padStart(2,'0') + ':' + String(n.getMinutes()).padStart(2,'0');
            const d = ['ÊòüÊúüÊó•','ÊòüÊúü‰∏Ä','ÊòüÊúü‰∫å','ÊòüÊúü‰∏â','ÊòüÊúüÂõõ','ÊòüÊúü‰∫î','ÊòüÊúüÂÖ≠'];
            $('lockDate').textContent = `${d[n.getDay()]}, ${n.getMonth()+1}Êúà${n.getDate()}Êó•`;
        }
        updateClock();
        setInterval(updateClock, 1000);

        // ===== HOLD TO OPEN =====
        function startHold() {
            if (hasStarted) return;
            holdProgress = 0;
            holdTimer = setInterval(() => {
                holdProgress += 2;
                holdFill.style.width = Math.min(holdProgress, 100) + '%';
                if (holdProgress >= 100) {
                    clearInterval(holdTimer); holdTimer = null;
                    hasStarted = true;
                    openGift();
                }
            }, 30);
        }
        function cancelHold() {
            if (holdTimer) { clearInterval(holdTimer); holdTimer = null; }
            if (!hasStarted) { holdProgress = 0; holdFill.style.width = '0%'; }
        }

        const gbw = $('giftBoxWrapper');
        gbw.addEventListener('mousedown', startHold);
        gbw.addEventListener('mouseup', cancelHold);
        gbw.addEventListener('mouseleave', cancelHold);
        gbw.addEventListener('touchstart', e => { e.preventDefault(); startHold(); }, { passive:false });
        gbw.addEventListener('touchend', cancelHold);
        gbw.addEventListener('touchcancel', cancelHold);

        // ===== OPEN GIFT =====
        function openGift() {
            bgMusic.volume = 0.35;
            bgMusic.play().catch(() => {});
            $('giftBox').style.transition = 'transform 0.5s ease';
            $('giftBox').style.transform = 'scale(2) rotate(20deg)';
            createConfetti(35);
            setTimeout(() => {
                lockScreen.classList.add('hidden');
                setTimeout(() => {
                    lockScreen.style.display = 'none';
                    startPhase1();
                }, 800);
            }, 500);
        }

        // ===== PHASE 1: CODE EDITOR =====
        function startPhase1() {
            editorPhase.classList.add('show');
            setTimeout(() => editorContainer.classList.add('show'), 100);

            let li = 0;
            function typeLine() {
                if (li >= code.length) {
                    terminal.classList.add('show');
                    animateProgress().then(() => setTimeout(startPhase2, 1000));
                    return;
                }
                const line = code[li];
                const div = document.createElement('div');
                div.className = 'code-line';
                const num = document.createElement('span');
                num.className = 'line-number';
                num.textContent = line.line;
                const content = document.createElement('span');
                content.className = 'code-content';
                div.appendChild(num);
                div.appendChild(content);
                codeOutput.appendChild(div);

                if (!line.tokens.length) { li++; setTimeout(typeLine, 80); return; }

                let ti = 0;
                function nextTok() {
                    if (ti >= line.tokens.length) { rmCur(); li++; setTimeout(typeLine, 100); return; }
                    const tok = line.tokens[ti];
                    const sp = document.createElement('span');
                    sp.className = tok.type;
                    content.appendChild(sp);
                    let ci = 0;
                    function nextCh() {
                        rmCur();
                        if (ci >= tok.text.length) { ti++; nextTok(); return; }
                        sp.textContent += tok.text[ci++];
                        const cur = document.createElement('span');
                        cur.className = 'blinking-cursor';
                        content.appendChild(cur);
                        setTimeout(nextCh, 20 + Math.random() * 20);
                    }
                    nextCh();
                }
                nextTok();
            }
            function rmCur() { const c = codeOutput.querySelector('.blinking-cursor'); if(c) c.remove(); }
            setTimeout(typeLine, 350);
        }

        function animateProgress() {
            const fill = $('progressFill'), pct = $('progressPercent'), ok = $('buildSuccess');
            let p = 0;
            return new Promise(res => {
                const iv = setInterval(() => {
                    p += 2;
                    fill.textContent = '‚ñà'.repeat(Math.floor(p/10)) + '‚ñë'.repeat(10 - Math.floor(p/10));
                    pct.textContent = p + '%';
                    if (p >= 100) { clearInterval(iv); ok.style.display = 'flex'; res(); }
                }, 40);
            });
        }

        // ===== PHASE 2: GLITCH ‚Üí SCROLL SECTIONS =====
        function startPhase2() {
            editorContainer.classList.add('glitch-out');
            setTimeout(() => {
                editorPhase.style.display = 'none';
                mainScroll.classList.add('show');
                resizeCanvas();
                initParticles();
                animateParticles();
                setupScrollObservers();
            }, 850);
        }

        // ===== SCROLL-TRIGGERED ANIMATIONS =====
        function setupScrollObservers() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (!entry.isIntersecting) return;
                    const id = entry.target.id;

                    if (id === 'photoSection') {
                        $('galleryTitle').classList.add('show');
                        $('gallerySubtitle').classList.add('show');
                        document.querySelectorAll('.photo-card').forEach(c => c.classList.add('show'));
                    }

                    if (id === 'chatSection' && !chatWrapper.classList.contains('show')) {
                        chatWrapper.classList.add('show');
                        setTimeout(startChatSequence, 600);
                    }

                    if (id === 'finalSection') {
                        $('finalMessage').classList.add('show');
                        createConfetti(100);
                    }
                });
            }, { threshold: 0.3 });

            observer.observe($('photoSection'));
            observer.observe($('chatSection'));
            observer.observe($('finalSection'));
        }

        // ===== DRAMATIC 3D HEART PARTICLE SYSTEM =====
        let particles = [];
        let bgStars = [];
        let sparkles = [];
        let animStartTime = 0;

        function resizeCanvas() {
            const section = $('heartSection');
            canvas.width = section.clientWidth;
            canvas.height = section.clientHeight;
        }
        window.addEventListener('resize', () => { resizeCanvas(); if (particles.length) initParticles(); });

        // Heart parametric equation
        function heartX(t) { return 16 * Math.pow(Math.sin(t), 3); }
        function heartY(t) { return -(13*Math.cos(t) - 5*Math.cos(2*t) - 2*Math.cos(3*t) - Math.cos(4*t)); }

        function initParticles() {
            particles = [];
            bgStars = [];
            sparkles = [];
            animStartTime = Date.now();

            const heartSize = Math.min(canvas.width, canvas.height) * 0.38;
            const scale = heartSize / 32;

            // 3D heart particles: multiple depth layers
            const layers = 8;
            const outlinePerLayer = 90;

            for (let layer = 0; layer < layers; layer++) {
                const zNorm = (layer / (layers - 1)) * 2 - 1;
                const zScale = Math.sqrt(Math.max(0, 1 - zNorm * zNorm));

                // Outline
                for (let i = 0; i < outlinePerLayer; i++) {
                    const t = (i / outlinePerLayer) * Math.PI * 2;
                    const hx = heartX(t) * scale * zScale;
                    const hy = heartY(t) * scale * zScale;
                    const hz = zNorm * heartSize * 0.2;

                    const hue = 330 + Math.random() * 40;
                    const lit = 55 + Math.random() * 30;
                    particles.push({
                        // Target position (heart shape)
                        tx: hx, ty: hy, tz: hz,
                        // Current position (random scatter for entrance)
                        cx: (Math.random() - 0.5) * canvas.width * 1.5,
                        cy: (Math.random() - 0.5) * canvas.height * 1.5,
                        cz: (Math.random() - 0.5) * 600,
                        size: Math.random() * 2.5 + 1.5,
                        col: `hsl(${hue},100%,${lit}%)`,
                        speed: 0.015 + Math.random() * 0.015,
                        sparkTimer: Math.random() * 100
                    });
                }

                // Fill interior
                const fillCount = Math.floor(50 * zScale * zScale);
                for (let i = 0; i < fillCount; i++) {
                    const t = Math.random() * Math.PI * 2;
                    const r = Math.random() * 0.75;
                    const hx = heartX(t) * r * scale * zScale;
                    const hy = heartY(t) * r * scale * zScale;
                    const hz = zNorm * heartSize * 0.2;

                    const hue = 330 + Math.random() * 40;
                    const lit = 50 + Math.random() * 35;
                    particles.push({
                        tx: hx, ty: hy, tz: hz,
                        cx: (Math.random() - 0.5) * canvas.width * 1.5,
                        cy: (Math.random() - 0.5) * canvas.height * 1.5,
                        cz: (Math.random() - 0.5) * 600,
                        size: Math.random() * 2 + 1,
                        col: `hsl(${hue},100%,${lit}%)`,
                        speed: 0.015 + Math.random() * 0.015,
                        sparkTimer: Math.random() * 100
                    });
                }
            }

            // Background ambient stars
            for (let i = 0; i < 120; i++) {
                bgStars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: Math.random() * 1.5 + 0.5,
                    twinkleSpeed: 0.01 + Math.random() * 0.03,
                    twinkleOffset: Math.random() * Math.PI * 2,
                    col: Math.random() > 0.7 ? '#ff9ec4' : '#ffffff'
                });
            }
        }

        let rotAngle = 0;
        function animateParticles() {
            const now = Date.now();
            const elapsed = (now - animStartTime) / 1000; // seconds since start
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const cx = canvas.width / 2;
            const cy = canvas.height * 0.44;

            // ---- BACKGROUND STARS ----
            for (let i = 0; i < bgStars.length; i++) {
                const s = bgStars[i];
                const alpha = 0.3 + 0.4 * Math.sin(now * s.twinkleSpeed * 0.001 + s.twinkleOffset);
                ctx.globalAlpha = alpha;
                ctx.fillStyle = s.col;
                ctx.beginPath();
                ctx.arc(s.x, s.y, s.size, 0, 6.283);
                ctx.fill();
            }

            // ---- HEART GLOW (radial gradient behind heart) ----
            const glowPulse = 1 + Math.sin(now * 0.003) * 0.15;
            const glowRadius = Math.min(canvas.width, canvas.height) * 0.35 * glowPulse;
            const glowGrad = ctx.createRadialGradient(cx, cy, 0, cx, cy, glowRadius);
            glowGrad.addColorStop(0, 'rgba(255, 50, 100, 0.12)');
            glowGrad.addColorStop(0.5, 'rgba(255, 50, 100, 0.05)');
            glowGrad.addColorStop(1, 'rgba(255, 50, 100, 0)');
            ctx.globalAlpha = 1;
            ctx.fillStyle = glowGrad;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ---- ENTRANCE ANIMATION (particles fly to target) ----
            // Phase: 0-2s gathering, 2s+ formed
            const gatherProgress = Math.min(1, elapsed / 2.0);
            const eased = 1 - Math.pow(1 - gatherProgress, 3); // ease-out cubic

            // Move particles toward target
            for (let i = 0; i < particles.length; i++) {
                const p = particles[i];
                p.cx += (p.tx - p.cx) * p.speed * (1 + eased * 3);
                p.cy += (p.ty - p.cy) * p.speed * (1 + eased * 3);
                p.cz += (p.tz - p.cz) * p.speed * (1 + eased * 3);
            }

            // ---- 3D ROTATION (only after mostly formed) ----
            if (eased > 0.8) {
                rotAngle += 0.008;
            }

            // ---- HEARTBEAT (dramatic pump after formed) ----
            let beat = 1;
            if (eased >= 1) {
                // Realistic double-beat: lub-dub
                const t = (now % 1200) / 1200;
                if (t < 0.1) {
                    beat = 1 + 0.12 * Math.sin(t / 0.1 * Math.PI);
                } else if (t > 0.15 && t < 0.25) {
                    beat = 1 + 0.08 * Math.sin((t - 0.15) / 0.1 * Math.PI);
                } else {
                    beat = 1;
                }
            }

            const cosA = Math.cos(rotAngle);
            const sinA = Math.sin(rotAngle);
            const fov = 400;
            const camDist = 250;

            // ---- PROJECT ALL PARTICLES ----
            const projected = [];
            for (let i = 0; i < particles.length; i++) {
                const p = particles[i];
                const bx = p.cx * beat;
                const by = p.cy * beat;
                const bz = p.cz * beat;
                // Y-axis rotation
                const rx = bx * cosA - bz * sinA;
                const rz = bx * sinA + bz * cosA;
                // Perspective
                const d = fov / (fov + camDist + rz);
                projected.push({
                    px: cx + rx * d,
                    py: cy + by * d,
                    sz: Math.max(0.5, p.size * d * beat),
                    rz: rz,
                    alpha: Math.max(0.2, Math.min(1, d * 1.3)) * Math.min(1, elapsed * 0.8),
                    col: p.col
                });
            }

            // Sort back-to-front
            projected.sort((a, b) => a.rz - b.rz);

            // ---- DRAW PARTICLES ----
            for (let i = 0; i < projected.length; i++) {
                const q = projected[i];
                // Outer glow
                ctx.globalAlpha = q.alpha * 0.2;
                ctx.fillStyle = q.col;
                ctx.beginPath();
                ctx.arc(q.px, q.py, q.sz * 3, 0, 6.283);
                ctx.fill();
                // Main particle
                ctx.globalAlpha = q.alpha;
                ctx.beginPath();
                ctx.arc(q.px, q.py, q.sz, 0, 6.283);
                ctx.fill();
                // Bright center
                ctx.globalAlpha = q.alpha * 0.7;
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.arc(q.px, q.py, q.sz * 0.35, 0, 6.283);
                ctx.fill();
            }

            // ---- FLOATING SPARKLES (emitted from heart) ----
            if (eased >= 0.9 && Math.random() < 0.3) {
                const t = Math.random() * Math.PI * 2;
                const hx = heartX(t) * Math.min(canvas.width, canvas.height) * 0.38 / 32;
                const hy = heartY(t) * Math.min(canvas.width, canvas.height) * 0.38 / 32;
                sparkles.push({
                    x: cx + hx * beat, y: cy + hy * beat,
                    vx: (Math.random() - 0.5) * 1.5,
                    vy: -Math.random() * 2 - 0.5,
                    life: 1,
                    decay: 0.008 + Math.random() * 0.015,
                    size: Math.random() * 2 + 1
                });
            }

            for (let i = sparkles.length - 1; i >= 0; i--) {
                const sp = sparkles[i];
                sp.x += sp.vx;
                sp.y += sp.vy;
                sp.life -= sp.decay;
                if (sp.life <= 0) { sparkles.splice(i, 1); continue; }
                ctx.globalAlpha = sp.life * 0.7;
                ctx.fillStyle = '#ffb6c1';
                ctx.beginPath();
                ctx.arc(sp.x, sp.y, sp.size * sp.life, 0, 6.283);
                ctx.fill();
                // Sparkle white core
                ctx.globalAlpha = sp.life * 0.5;
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.arc(sp.x, sp.y, sp.size * sp.life * 0.4, 0, 6.283);
                ctx.fill();
            }

            ctx.globalAlpha = 1;

            // ---- "ÈºéË∂ÖËàáÊòéËã±" TEXT below heart ----
            if (eased > 0.5) {
                const textAlpha = Math.min(1, (eased - 0.5) * 2);
                const textBeat = beat;
                const fontSize = Math.min(canvas.width, canvas.height) * 0.055;
                ctx.save();
                ctx.font = `600 ${fontSize}px 'Noto Sans', sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'top';
                // Glow
                ctx.globalAlpha = textAlpha * 0.4;
                ctx.fillStyle = '#ff6b9d';
                const textY = cy + Math.min(canvas.width, canvas.height) * 0.28 * textBeat;
                ctx.fillText('ÈºéË∂ÖËàáÊòéËã±', cx, textY);
                // Main text with gradient
                ctx.globalAlpha = textAlpha;
                const grad = ctx.createLinearGradient(cx - 80, textY, cx + 80, textY);
                grad.addColorStop(0, '#ff6b9d');
                grad.addColorStop(0.5, '#fd79a8');
                grad.addColorStop(1, '#e84393');
                ctx.fillStyle = grad;
                ctx.fillText('ÈºéË∂ÖËàáÊòéËã±', cx, textY);
                ctx.restore();
            }

            requestAnimationFrame(animateParticles);
        }

        // ===== CHAT SEQUENCE =====
        function startChatSequence() {
            let idx = 0;
            function next() {
                if (idx >= chatSequence.length) return;
                const msg = chatSequence[idx];

                const bubble = document.createElement('div');
                bubble.className = 'chat-bubble' + (msg.type === 'sent' ? ' sent' : '');
                bubble.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
                chatMessages.appendChild(bubble);
                requestAnimationFrame(() => bubble.classList.add('show'));

                setTimeout(() => {
                    if (msg.isLove) {
                        const cls = msg.lang === 'zh' ? 'love-text love-text-zh' : 'love-text';
                        bubble.innerHTML = `<div class="${cls}">${msg.text}</div>`;
                    } else {
                        bubble.innerHTML = msg.text;
                    }
                    const t = document.createElement('div');
                    t.className = 'chat-time';
                    const n = new Date();
                    t.textContent = String(n.getHours()).padStart(2,'0')+':'+String(n.getMinutes()).padStart(2,'0');
                    bubble.appendChild(t);

                    idx++;
                    setTimeout(next, 700);
                }, 1100);
            }
            next();
        }

        // ===== CONFETTI =====
        function createConfetti(count) {
            const cols = ['#ff6b9d','#e84393','#f8b500','#a29bfe','#fd79a8','#ff4757','#ffa502'];
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const el = document.createElement('div');
                    el.className = 'confetti';
                    el.style.left = Math.random()*100 + '%';
                    el.style.width = (Math.random()*10+5) + 'px';
                    el.style.height = (Math.random()*10+5) + 'px';
                    el.style.background = cols[Math.floor(Math.random()*cols.length)];
                    el.style.borderRadius = Math.random()>0.5?'50%':'2px';
                    document.body.appendChild(el);
                    const xD = (Math.random()-0.5)*300, spin = Math.random()*720-360;
                    const dur = (Math.random()*2.5+2)*1000;
                    el.animate([
                        { transform:'translateY(0) translateX(0) rotate(0) scale(0)', opacity:0 },
                        { opacity:1, offset:0.1 },
                        { transform:`translateY(${innerHeight+30}px) translateX(${xD}px) rotate(${spin}deg) scale(0.3)`, opacity:0 }
                    ], { duration:dur, easing:'cubic-bezier(.25,.46,.45,.94)' }).onfinish = () => el.remove();
                }, i*25);
            }
        }

    })();
    </script>
</body>
</html>
