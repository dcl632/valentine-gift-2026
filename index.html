<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Code of Love üíñ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Dancing+Script:wght@400;700&family=Noto+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --pink: #ff6b9d;
            --deep-pink: #e84393;
            --soft-pink: #fd79a8;
            --purple: #a29bfe;
            --dark: #0a0a0f;
            --darker: #060608;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans', sans-serif;
            background: var(--darker);
            color: #e0e0e0;
            -webkit-tap-highlight-color: transparent;
        }

        /* ========== SCROLLABLE MAIN ========== */
        #mainScroll {
            display: none;
            width: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            scroll-snap-type: y proximity;
        }

        #mainScroll.show {
            display: block;
        }

        .section {
            min-height: 100vh;
            min-height: 100dvh;
            width: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            scroll-snap-align: start;
            overflow: hidden;
        }

        /* Floating hearts removed for cleaner look */

        /* ========== PHASE 0: LOCK SCREEN ========== */
        #lockScreen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(160deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.8s ease, transform 0.8s ease;
        }

        #lockScreen.hidden {
            opacity: 0;
            transform: scale(1.1);
            pointer-events: none;
        }

        .lock-time {
            font-size: clamp(64px, 16vw, 110px);
            font-weight: 300;
            letter-spacing: -3px;
            color: #fff;
            text-shadow: 0 0 50px rgba(255, 107, 157, 0.35);
        }

        .lock-date {
            font-size: clamp(14px, 3vw, 17px);
            color: rgba(255, 255, 255, 0.6);
            margin-top: 4px;
            margin-bottom: 55px;
            font-weight: 300;
        }

        /* Heart row removed */

        .gift-box-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }

        .gift-box {
            font-size: 68px;
            animation: giftBounce 2s ease-in-out infinite;
            filter: drop-shadow(0 0 25px rgba(255, 107, 157, 0.5));
            transition: transform 0.3s;
        }

        @keyframes giftBounce {
            0%, 100% { transform: translateY(0) rotate(-3deg); }
            50%      { transform: translateY(-14px) rotate(3deg); }
        }

        .hold-text {
            margin-top: 16px;
            font-size: 15px;
            color: var(--pink);
            font-weight: 400;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.45; }
            50%      { opacity: 1; }
        }

        .hold-progress {
            width: 180px;
            height: 3px;
            background: rgba(255, 255, 255, 0.12);
            border-radius: 2px;
            margin-top: 14px;
            overflow: hidden;
        }

        .hold-progress-fill {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--pink), var(--purple));
            border-radius: 2px;
            transition: width 0.1s linear;
        }

        /* ========== PHASE 1: CODE EDITOR ========== */
        #editorPhase {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            background: var(--darker);
        }

        #editorPhase.show {
            display: flex;
        }

        #editorContainer {
            width: 92%;
            max-width: 660px;
            background: #1e1e2e;
            border-radius: 14px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(255,255,255,0.05);
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.8s ease;
        }

        #editorContainer.show { opacity: 1; }

        #editorContainer.glitch-out {
            animation: glitchOut 0.8s ease forwards;
        }

        @keyframes glitchOut {
            0%   { transform: scale(1); filter: none; }
            20%  { transform: skewX(5deg) scale(1); filter: hue-rotate(90deg); }
            40%  { transform: skewX(-3deg) scale(1.02); filter: hue-rotate(180deg) brightness(1.5); }
            60%  { transform: skewX(2deg) scale(0.98); filter: hue-rotate(270deg); }
            80%  { transform: scale(1.05); filter: brightness(3) saturate(0); opacity: 0.5; }
            100% { transform: scale(0); filter: brightness(5); opacity: 0; }
        }

        .editor-header {
            background: #181825;
            padding: 13px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .editor-dot { width: 12px; height: 12px; border-radius: 50%; }
        .dot-red    { background: #f38ba8; }
        .dot-yellow { background: #f9e2af; }
        .dot-green  { background: #a6e3a1; }

        .editor-title {
            margin-left: 12px;
            font-family: 'Fira Code', monospace;
            font-size: 12px;
            color: #585b70;
        }

        .editor-body {
            padding: 18px 20px;
            min-height: 260px;
            background: #1e1e2e;
            font-family: 'Fira Code', monospace;
        }

        .code-line {
            display: flex;
            gap: 16px;
            margin-bottom: 5px;
            font-size: clamp(11.5px, 2.4vw, 14.5px);
            line-height: 1.75;
        }

        .line-number { color: #45475a; user-select: none; min-width: 24px; text-align: right; }
        .code-content { flex: 1; white-space: pre-wrap; word-break: break-word; }

        .keyword  { color: #cba6f7; }
        .variable { color: #89b4fa; }
        .string   { color: #a6e3a1; }
        .number   { color: #fab387; }
        .comment  { color: #585b70; font-style: italic; }
        .function { color: #f9e2af; }
        .operator { color: #cdd6f4; }

        .blinking-cursor {
            display: inline-block;
            width: 2px; height: 15px;
            background: #cdd6f4;
            animation: blink 1s step-end infinite;
            vertical-align: text-bottom;
            margin-left: 1px;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .terminal {
            background: #11111b;
            padding: 12px 16px;
            margin-top: 14px;
            border-radius: 8px;
            font-size: 11.5px;
            font-family: 'Fira Code', monospace;
            display: none;
            border: 1px solid rgba(255,255,255,0.03);
        }

        .terminal.show { display: block; animation: fadeIn 0.3s ease; }
        .terminal-line { margin-bottom: 5px; color: #a6adc8; }
        .terminal-line .prompt { color: #a6e3a1; }
        .progress-bar { display: flex; align-items: center; gap: 10px; margin-top: 6px; }
        .progress-fill { color: #94e2d5; }
        .build-success { color: #a6e3a1; margin-top: 8px; display: flex; align-items: center; gap: 6px; }

        /* ========== SECTION 1: HEART CANVAS ========== */
        #heartSection {
            background: radial-gradient(ellipse at center, #12101e 0%, var(--darker) 70%);
        }

        #canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
        }

        .scroll-hint {
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 13px;
            color: rgba(255,255,255,0.35);
            animation: bounceDown 2s ease-in-out infinite;
            z-index: 10;
            text-align: center;
        }

        .scroll-hint span {
            display: block;
            font-size: 20px;
            margin-top: 4px;
        }

        @keyframes bounceDown {
            0%, 100% { transform: translateX(-50%) translateY(0); opacity: 0.35; }
            50%      { transform: translateX(-50%) translateY(8px); opacity: 0.7; }
        }

        /* ========== SECTION 2: PHOTO GALLERY ========== */
        #photoSection {
            background: linear-gradient(180deg, var(--darker) 0%, #110a1a 50%, var(--darker) 100%);
            padding: 60px 0;
            min-height: 100vh;
            justify-content: flex-start;
            padding-top: 10vh;
        }

        .gallery-title {
            font-size: clamp(22px, 5vw, 32px);
            font-weight: 300;
            color: rgba(255,255,255,0.85);
            margin-bottom: 8px;
            text-align: center;
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.8s ease, transform 0.8s ease;
        }

        .gallery-title.show {
            opacity: 1;
            transform: translateY(0);
        }

        .gallery-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.4);
            margin-bottom: 40px;
            text-align: center;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.8s ease 0.2s, transform 0.8s ease 0.2s;
        }

        .gallery-subtitle.show {
            opacity: 1;
            transform: translateY(0);
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 14px;
            width: 88%;
            max-width: 420px;
            padding: 0 10px;
        }

        .photo-card {
            background: rgba(255, 255, 255, 0.06);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transform: translateY(40px) scale(0.95);
            transition: opacity 0.7s ease, transform 0.7s ease;
        }

        .photo-card.show {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        .photo-card:nth-child(2) { transition-delay: 0.15s; }
        .photo-card:nth-child(3) { transition-delay: 0.3s; }
        .photo-card:nth-child(4) { transition-delay: 0.45s; }

        .photo-card img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            display: block;
        }

        .photo-card .caption {
            padding: 10px 12px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.55);
            text-align: center;
        }

        /* ========== SECTION 3: CHAT MESSAGE ========== */
        #chatSection {
            background: linear-gradient(180deg, var(--darker) 0%, #0d0a16 50%, var(--darker) 100%);
            padding: 40px 0;
            min-height: 100vh;
            justify-content: center;
        }

        .chat-wrapper {
            width: 90%;
            max-width: 440px;
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.8s ease, transform 0.8s ease;
        }

        .chat-wrapper.show {
            opacity: 1;
            transform: translateY(0);
        }

        .chat-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            margin-bottom: 12px;
            background: rgba(255, 255, 255, 0.06);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.08);
        }

        .chat-avatar {
            width: 42px; height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--pink), var(--purple));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 0 18px rgba(255, 107, 157, 0.25);
            flex-shrink: 0;
        }

        .chat-name {
            font-weight: 600;
            font-size: 15px;
            color: rgba(255,255,255,0.9);
        }

        .chat-status {
            font-size: 11.5px;
            color: #a6e3a1;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 1px;
        }

        .chat-status::before {
            content: '';
            width: 6px; height: 6px;
            border-radius: 50%;
            background: #a6e3a1;
        }

        .chat-bubble {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 18px 18px 18px 6px;
            border: 1px solid rgba(255,255,255,0.12);
            padding: 14px 18px;
            margin-bottom: 10px;
            max-width: 88%;
            font-size: 14.5px;
            line-height: 1.6;
            color: rgba(255,255,255,0.92);
            opacity: 0;
            transform: translateY(16px);
            transition: opacity 0.5s ease, transform 0.5s ease;
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
        }

        .chat-bubble.show { opacity: 1; transform: translateY(0); }

        .chat-bubble.sent {
            background: linear-gradient(135deg, var(--deep-pink), var(--pink));
            border-radius: 18px 18px 6px 18px;
            margin-left: auto;
            border: none;
            color: #fff;
        }

        .chat-bubble .typing-dots {
            display: inline-flex;
            gap: 4px;
            padding: 4px 0;
        }

        .chat-bubble .typing-dots span {
            width: 7px; height: 7px;
            border-radius: 50%;
            background: rgba(255,255,255,0.45);
            animation: dotBounce 1.4s ease-in-out infinite;
        }

        .chat-bubble .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .chat-bubble .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes dotBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30%            { transform: translateY(-7px); }
        }

        .chat-time {
            font-size: 10.5px;
            color: rgba(255,255,255,0.45);
            margin-top: 4px;
        }

        .love-text {
            font-weight: 500;
            font-size: 15px;
            line-height: 1.65;
        }

        .love-text-zh {
            font-family: 'Dancing Script', cursive;
            font-size: clamp(22px, 5.5vw, 30px);
            line-height: 1.4;
        }

        /* ========== SECTION 4: FINAL ========== */
        #finalSection {
            background: radial-gradient(ellipse at 50% 40%, #1a0f2e 0%, var(--darker) 70%);
            min-height: 60vh;
            justify-content: center;
        }

        .final-message {
            text-align: center;
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 1s ease, transform 1s ease;
        }

        .final-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        .final-big-heart {
            font-size: 60px;
            animation: heartBeat 1.5s infinite;
            margin-bottom: 20px;
        }

        @keyframes heartBeat {
            0%, 100% { transform: scale(1); }
            15%      { transform: scale(1.15); }
            30%      { transform: scale(1); }
        }

        .final-line {
            font-size: clamp(14px, 3.5vw, 18px);
            color: rgba(255, 255, 255, 0.7);
            font-weight: 300;
            line-height: 1.8;
            padding: 0 30px;
        }

        .final-line strong {
            color: var(--pink);
            font-weight: 500;
        }

        .footer-text {
            margin-top: 40px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.3);
            text-align: center;
        }

        /* ========== CONFETTI ========== */
        .confetti {
            position: fixed;
            top: -15px;
            pointer-events: none;
            z-index: 9999;
        }

        /* ========== UTILITY ========== */
        @keyframes fadeIn {
            from { opacity: 0; } to { opacity: 1; }
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 500px) {
            .gift-box { font-size: 55px; }
            .photo-grid { gap: 10px; width: 92%; }
            .photo-card .caption { padding: 8px 10px; font-size: 11px; }
            .chat-bubble { padding: 12px 15px; font-size: 13.5px; }
            .love-text { font-size: 14px; }
            .love-text-zh { font-size: 20px; }
            .gallery-title { font-size: 22px; }
            .final-big-heart { font-size: 48px; }
        }
    </style>
</head>
<body>

    <!-- ====== PHASE 0: LOCK SCREEN ====== -->
    <div id="lockScreen">
        <div class="lock-time" id="lockTime">21:14</div>
        <div class="lock-date" id="lockDate">Th·ª© S√°u, 14 th√°ng 2</div>
        <div class="gift-box-wrapper" id="giftBoxWrapper">
            <div class="gift-box" id="giftBox">üéÅ</div>
            <div class="hold-text">Èï∑ÊåâÈñãÂïüÁ¶ÆÁâ© üíù</div>
            <div class="hold-progress">
                <div class="hold-progress-fill" id="holdFill"></div>
            </div>
        </div>
    </div>

    <!-- ====== PHASE 1: CODE EDITOR (floating overlay) ====== -->
    <div id="editorPhase">
        <div id="editorContainer">
            <div class="editor-header">
                <div class="editor-dot dot-red"></div>
                <div class="editor-dot dot-yellow"></div>
                <div class="editor-dot dot-green"></div>
                <div class="editor-title">love_algorithm.js ‚Äî Code of Love</div>
            </div>
            <div class="editor-body">
                <div id="codeOutput"></div>
                <div class="terminal" id="terminal">
                    <div class="terminal-line"><span class="prompt">‚ùØ</span> npm run build:love</div>
                    <div class="terminal-line">Ê≠£Âú®Á∑®Ë≠ØÊàÄÊÑõÊºîÁÆóÊ≥ï...</div>
                    <div class="progress-bar">
                        <span>[<span class="progress-fill" id="progressFill"></span>]</span>
                        <span id="progressPercent" style="color:#94e2d5">0%</span>
                    </div>
                    <div class="build-success" id="buildSuccess" style="display:none;">
                        <span>‚úì</span> Âª∫ÁΩÆÊàêÂäü ‚Äî Ê∫ñÂÇôÈÄ≤ÂÖ•Â¶≥ÁöÑÂøÉ...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ====== SCROLLABLE SECTIONS ====== -->
    <div id="mainScroll">

        <!-- SECTION 1: Particle Heart -->
        <section class="section" id="heartSection">
            <canvas id="canvas"></canvas>
            <div class="scroll-hint" id="scrollHint">
                Âêë‰∏ãÊªëÂãï
                <span>‚Üì</span>
            </div>
        </section>

        <!-- SECTION 2: Photo Gallery -->
        <section class="section" id="photoSection">
            <div class="gallery-title" id="galleryTitle">Our Memories üíï</div>
            <div class="gallery-subtitle" id="gallerySubtitle">ÊØè‰∏ÄÂàªÈÉΩÂÄºÂæóÁèçËóè</div>
            <div class="photo-grid" id="photoGrid">
                <!-- ‚òÖ REPLACE src with your actual photo URLs ‚òÖ -->
                <div class="photo-card">
                    <img src="https://via.placeholder.com/300/ff6b9d/ffffff?text=Us+1" alt="Memory 1">
                    <div class="caption">Á¨¨‰∏ÄÊ¨°Ë¶ãÈù¢ ‚ú®</div>
                </div>
                <div class="photo-card">
                    <img src="https://via.placeholder.com/300/c44569/ffffff?text=Us+2" alt="Memory 2">
                    <div class="caption">ÈÇ£Â§©ÁöÑÁ¨ëÂÆπ üí´</div>
                </div>
                <div class="photo-card">
                    <img src="https://via.placeholder.com/300/f8b500/ffffff?text=Us+3" alt="Memory 3">
                    <div class="caption">Âú®‰∏ÄËµ∑ÁöÑÊôÇÂÖâ üå∏</div>
                </div>
                <div class="photo-card">
                    <img src="https://via.placeholder.com/300/a29bfe/ffffff?text=Us+4" alt="Memory 4">
                    <div class="caption">Ê∞∏ÈÅ†Ë®òÂæó‰Ω† üíñ</div>
                </div>
            </div>
        </section>

        <!-- SECTION 3: Chat Messages -->
        <section class="section" id="chatSection">
            <div class="chat-wrapper" id="chatWrapper">
                <div class="chat-header">
                    <div class="chat-avatar">üíª</div>
                    <div>
                        <div class="chat-name">Code of Love</div>
                        <div class="chat-status">ƒêang ho·∫°t ƒë·ªông</div>
                    </div>
                </div>
                <div id="chatMessages"></div>
            </div>
        </section>

        <!-- SECTION 4: Final -->
        <section class="section" id="finalSection">
            <div class="final-message" id="finalMessage">
                <div class="final-big-heart">‚ù§Ô∏è</div>
                <div class="final-line">
                    Happy Valentine's Day<br>
                    <strong>Ë¶™ÊÑõÁöÑ</strong>ÔºåÊàëÊÑõÂ¶≥Áõ¥Âà∞Ê∞∏ÈÅ†
                </div>
                <div class="footer-text">
                    Made with ‚ù§Ô∏è by ÂªñÈºéË∂Ö ¬∑ Valentine 2026
                </div>
            </div>
        </section>

    </div>

    <!-- Audio -->
    <audio id="bgMusic" loop>
        <!-- ‚òÖ REPLACE with your romantic music URL ‚òÖ -->
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
    </audio>

    <script>
    (function() {
        'use strict';

        // ===== CODE =====
        const code = [
            { line: 1, tokens: [
                { type:'keyword',text:'const' },{ type:'variable',text:' myWorld' },
                { type:'operator',text:' = ' },{ type:'keyword',text:'new' },
                { type:'function',text:' Life' },{ type:'operator',text:'();' }
            ]},
            { line: 2, tokens: [
                { type:'keyword',text:'const' },{ type:'variable',text:' you' },
                { type:'operator',text:' = ' },{ type:'string',text:'"Â¶≥"' },
                { type:'operator',text:';' },{ type:'comment',text:' // ÊàëÁöÑÂπ∏Á¶è' }
            ]},
            { line: 3, tokens: [] },
            { line: 4, tokens: [
                { type:'keyword',text:'while' },{ type:'operator',text:' (' },
                { type:'variable',text:'alive' },{ type:'operator',text:') {' }
            ]},
            { line: 5, tokens: [
                { type:'operator',text:'  ' },{ type:'variable',text:'myWorld' },
                { type:'operator',text:'.' },{ type:'function',text:'orbit' },
                { type:'operator',text:'(' },{ type:'variable',text:'you' },
                { type:'operator',text:');' }
            ]},
            { line: 6, tokens: [
                { type:'operator',text:'  ' },{ type:'keyword',text:'if' },
                { type:'operator',text:' (' },{ type:'function',text:'near' },
                { type:'operator',text:'(' },{ type:'variable',text:'you' },
                { type:'operator',text:')) {' }
            ]},
            { line: 7, tokens: [
                { type:'operator',text:'     ' },{ type:'variable',text:'heartRate' },
                { type:'operator',text:' += ' },{ type:'number',text:'1000' },
                { type:'operator',text:';' }
            ]},
            { line: 8, tokens: [{ type:'operator',text:'  }' }] },
            { line: 9, tokens: [{ type:'operator',text:'}' }] },
            { line: 10, tokens: [{ type:'comment',text:'// Ê≠£Âú®Á∑®Ë≠ØÊÑõÊÑè...' }] }
        ];

        const chatSequence = [
            { type:'received', text:'Âª∫ÁΩÆÂÆåÊàê ‚úì' },
            { type:'received', text:'ÂàùÂßãÂåñÊÑõÂøÉÊ®°ÁµÑ... üíó' },
            { type:'received', text:'‚ù§Ô∏è ÊÑõÂøÉÂ∑≤ÈÉ®ÁΩ≤ÔºÅ' },
            { type:'sent', text:'ÈÄôÊòØÊàëË¶™ÊâãÁÇ∫Â¶≥ÂØ´ÁöÑÁ®ãÂºèÔºåÂ∞àÂ±¨ÊñºÂ¶≥ ‚ù§Ô∏è', isLove:true, lang:'zh' },
            { type:'sent', text:'Â¶≥ÊòØÊàë‰∏ñÁïåÁöÑ‰∏≠ÂøÉ üíï', isLove:true, lang:'zh' },
        ];

        // ===== DOM =====
        const $ = id => document.getElementById(id);
        const lockScreen = $('lockScreen');
        const holdFill = $('holdFill');
        const editorPhase = $('editorPhase');
        const editorContainer = $('editorContainer');
        const codeOutput = $('codeOutput');
        const terminal = $('terminal');
        const mainScroll = $('mainScroll');
        const canvas = $('canvas');
        const ctx = canvas.getContext('2d');
        const chatWrapper = $('chatWrapper');
        const chatMessages = $('chatMessages');
        const bgMusic = $('bgMusic');

        let hasStarted = false;
        let holdTimer = null;
        let holdProgress = 0;

        // ===== CLOCK =====
        function updateClock() {
            const n = new Date();
            $('lockTime').textContent = String(n.getHours()).padStart(2,'0') + ':' + String(n.getMinutes()).padStart(2,'0');
            const d = ['ÊòüÊúüÊó•','ÊòüÊúü‰∏Ä','ÊòüÊúü‰∫å','ÊòüÊúü‰∏â','ÊòüÊúüÂõõ','ÊòüÊúü‰∫î','ÊòüÊúüÂÖ≠'];
            $('lockDate').textContent = `${d[n.getDay()]}, ${n.getMonth()+1}Êúà${n.getDate()}Êó•`;
        }
        updateClock();
        setInterval(updateClock, 1000);

        // ===== HOLD TO OPEN =====
        function startHold() {
            if (hasStarted) return;
            holdProgress = 0;
            holdTimer = setInterval(() => {
                holdProgress += 2;
                holdFill.style.width = Math.min(holdProgress, 100) + '%';
                if (holdProgress >= 100) {
                    clearInterval(holdTimer); holdTimer = null;
                    hasStarted = true;
                    openGift();
                }
            }, 30);
        }
        function cancelHold() {
            if (holdTimer) { clearInterval(holdTimer); holdTimer = null; }
            if (!hasStarted) { holdProgress = 0; holdFill.style.width = '0%'; }
        }

        const gbw = $('giftBoxWrapper');
        gbw.addEventListener('mousedown', startHold);
        gbw.addEventListener('mouseup', cancelHold);
        gbw.addEventListener('mouseleave', cancelHold);
        gbw.addEventListener('touchstart', e => { e.preventDefault(); startHold(); }, { passive:false });
        gbw.addEventListener('touchend', cancelHold);
        gbw.addEventListener('touchcancel', cancelHold);

        // ===== OPEN GIFT =====
        function openGift() {
            bgMusic.volume = 0.35;
            bgMusic.play().catch(() => {});
            $('giftBox').style.transition = 'transform 0.5s ease';
            $('giftBox').style.transform = 'scale(2) rotate(20deg)';
            createConfetti(35);
            setTimeout(() => {
                lockScreen.classList.add('hidden');
                setTimeout(() => {
                    lockScreen.style.display = 'none';
                    startPhase1();
                }, 800);
            }, 500);
        }

        // ===== PHASE 1: CODE EDITOR =====
        function startPhase1() {
            editorPhase.classList.add('show');
            setTimeout(() => editorContainer.classList.add('show'), 100);

            let li = 0;
            function typeLine() {
                if (li >= code.length) {
                    terminal.classList.add('show');
                    animateProgress().then(() => setTimeout(startPhase2, 1000));
                    return;
                }
                const line = code[li];
                const div = document.createElement('div');
                div.className = 'code-line';
                const num = document.createElement('span');
                num.className = 'line-number';
                num.textContent = line.line;
                const content = document.createElement('span');
                content.className = 'code-content';
                div.appendChild(num);
                div.appendChild(content);
                codeOutput.appendChild(div);

                if (!line.tokens.length) { li++; setTimeout(typeLine, 80); return; }

                let ti = 0;
                function nextTok() {
                    if (ti >= line.tokens.length) { rmCur(); li++; setTimeout(typeLine, 100); return; }
                    const tok = line.tokens[ti];
                    const sp = document.createElement('span');
                    sp.className = tok.type;
                    content.appendChild(sp);
                    let ci = 0;
                    function nextCh() {
                        rmCur();
                        if (ci >= tok.text.length) { ti++; nextTok(); return; }
                        sp.textContent += tok.text[ci++];
                        const cur = document.createElement('span');
                        cur.className = 'blinking-cursor';
                        content.appendChild(cur);
                        setTimeout(nextCh, 20 + Math.random() * 20);
                    }
                    nextCh();
                }
                nextTok();
            }
            function rmCur() { const c = codeOutput.querySelector('.blinking-cursor'); if(c) c.remove(); }
            setTimeout(typeLine, 350);
        }

        function animateProgress() {
            const fill = $('progressFill'), pct = $('progressPercent'), ok = $('buildSuccess');
            let p = 0;
            return new Promise(res => {
                const iv = setInterval(() => {
                    p += 2;
                    fill.textContent = '‚ñà'.repeat(Math.floor(p/10)) + '‚ñë'.repeat(10 - Math.floor(p/10));
                    pct.textContent = p + '%';
                    if (p >= 100) { clearInterval(iv); ok.style.display = 'flex'; res(); }
                }, 40);
            });
        }

        // ===== PHASE 2: GLITCH ‚Üí SCROLL SECTIONS =====
        function startPhase2() {
            editorContainer.classList.add('glitch-out');
            setTimeout(() => {
                editorPhase.style.display = 'none';
                mainScroll.classList.add('show');
                resizeCanvas();
                initParticles();
                animateParticles();
                setupScrollObservers();
            }, 850);
        }

        // ===== SCROLL-TRIGGERED ANIMATIONS =====
        function setupScrollObservers() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (!entry.isIntersecting) return;
                    const id = entry.target.id;

                    if (id === 'photoSection') {
                        $('galleryTitle').classList.add('show');
                        $('gallerySubtitle').classList.add('show');
                        document.querySelectorAll('.photo-card').forEach(c => c.classList.add('show'));
                    }

                    if (id === 'chatSection' && !chatWrapper.classList.contains('show')) {
                        chatWrapper.classList.add('show');
                        setTimeout(startChatSequence, 600);
                    }

                    if (id === 'finalSection') {
                        $('finalMessage').classList.add('show');
                        createConfetti(100);
                    }
                });
            }, { threshold: 0.3 });

            observer.observe($('photoSection'));
            observer.observe($('chatSection'));
            observer.observe($('finalSection'));
        }

        // ===== PARTICLE SYSTEM =====
        let particles = [];
        let mouse = { x: -9999, y: -9999 };

        function resizeCanvas() {
            const section = $('heartSection');
            canvas.width = section.clientWidth;
            canvas.height = section.clientHeight;
        }
        window.addEventListener('resize', () => { resizeCanvas(); if (particles.length) initParticles(); });

        canvas.addEventListener('mousemove', e => {
            const r = canvas.getBoundingClientRect();
            mouse.x = e.clientX - r.left;
            mouse.y = e.clientY - r.top;
        });
        canvas.addEventListener('mouseleave', () => { mouse.x = mouse.y = -9999; });
        canvas.addEventListener('touchmove', e => {
            e.preventDefault();
            const r = canvas.getBoundingClientRect();
            mouse.x = e.touches[0].clientX - r.left;
            mouse.y = e.touches[0].clientY - r.top;
        }, { passive: false });
        canvas.addEventListener('touchend', () => { mouse.x = mouse.y = -9999; });

        class Particle {
            constructor() {
                this.x = (Math.random()-0.5) * canvas.width;
                this.y = (Math.random()-0.5) * canvas.height;
                this.z = (Math.random()-0.5) * 600;
                
                this.tx = 0; 
                this.ty = 0; 
                this.tz = 0;

                this.baseSize = Math.random()*2.5 + 1.5;
                // Pink/Red/Purple hues with more variation
                const hue = 320 + Math.random()*50; 
                const lit = 55 + Math.random()*25;
                this.hue = hue;
                this.lit = lit;
                this.col = `hsl(${hue}, 100%, ${lit}%)`;
            }

            update(angle, angleX) {
                // Smoothly move towards the target structure
                this.x += (this.tx - this.x) * 0.06;
                this.y += (this.ty - this.y) * 0.06;
                this.z += (this.tz - this.z) * 0.06;

                // 3D Rotation - Y axis (horizontal spin)
                const cosY = Math.cos(angle);
                const sinY = Math.sin(angle);
                
                // 3D Rotation - X axis (vertical tilt) for more dynamic view
                const cosX = Math.cos(angleX);
                const sinX = Math.sin(angleX);
                
                // Apply Y rotation
                let rotX = this.x * cosY - this.z * sinY;
                let rotZ = this.x * sinY + this.z * cosY;
                let rotY = this.y;
                
                // Apply X rotation
                const finalY = rotY * cosX - rotZ * sinX;
                const finalZ = rotY * sinX + rotZ * cosX;

                // Enhanced perspective projection
                const camZ = 600; 
                const fov = 500; 
                const scale = fov / (fov + camZ - finalZ);

                this.px = canvas.width/2 + rotX * scale;
                this.py = canvas.height*0.42 + finalY * scale;
                this.ps = this.baseSize * scale * 1.2; // Slightly larger particles
                this.depth = finalZ;
                this.alpha = Math.max(0.3, Math.min(1, scale * 1.2)); // Better visibility
            }

            draw() {
                if (this.ps < 0.5) return;
                
                // Enhanced glow effect based on depth
                const glowSize = 15 + (this.alpha * 10);
                ctx.shadowBlur = glowSize;
                ctx.shadowColor = `hsla(${this.hue}, 100%, ${this.lit}%, ${this.alpha * 0.8})`;
                
                ctx.globalAlpha = this.alpha;
                ctx.beginPath();
                ctx.arc(this.px, this.py, this.ps, 0, Math.PI*2);
                ctx.fillStyle = this.col;
                ctx.fill();
                
                // Inner bright core
                if (this.alpha > 0.6) {
                    ctx.shadowBlur = 8;
                    ctx.beginPath();
                    ctx.arc(this.px, this.py, this.ps * 0.5, 0, Math.PI*2);
                    ctx.fillStyle = `hsla(${this.hue}, 100%, 90%, ${this.alpha * 0.8})`;
                    ctx.fill();
                }
                
                ctx.globalAlpha = 1;
                ctx.shadowBlur = 0;
            }
        }

        function initParticles() {
            particles = [];
            // 3D Heart formula with denser sampling
            const amount = 2000; // Much more particles for fuller look
            const scale = Math.min(canvas.width, canvas.height) * 0.15; 
            
            let i = 0;
            let attempts = 0;
            while(i < amount && attempts < 80000) {
                attempts++;
                const x = (Math.random() * 3.2) - 1.6;
                const y = (Math.random() * 3.2) - 1.6;
                const z = (Math.random() * 3.2) - 1.6;

                const a = x*x + (9/4)*y*y + z*z - 1;
                // Heart volume check
                if (a*a*a - x*x*z*z*z - (9/80)*y*y*z*z*z < 0) {
                    const p = new Particle();
                    p.tx = x * scale;
                    p.ty = -y * scale; 
                    p.tz = z * scale;
                    particles.push(p);
                    i++;
                }
            }
        }

        let angle = 0;
        let angleX = 0;
        function animateParticles() {
            // Darker background for better glow effect
            ctx.fillStyle = 'rgba(10, 10, 15, 0.3)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Smooth rotation with slight bounce
            angle += 0.008; 
            angleX = Math.sin(angle * 0.5) * 0.15; // Gentle vertical tilt
            
            // Heartbeat pulsing effect
            const beat = 1 + Math.sin(Date.now()*0.002) * 0.08; 
            
            // Sort by depth for proper layering
            particles.sort((a, b) => (a.depth || 0) - (b.depth || 0));
            
            particles.forEach(p => {
                p.update(angle, angleX);
                p.draw();
            });

            requestAnimationFrame(animateParticles);
        }

        // ===== CHAT SEQUENCE =====
        function startChatSequence() {
            let idx = 0;
            function next() {
                if (idx >= chatSequence.length) return;
                const msg = chatSequence[idx];

                const bubble = document.createElement('div');
                bubble.className = 'chat-bubble' + (msg.type === 'sent' ? ' sent' : '');
                bubble.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
                chatMessages.appendChild(bubble);
                requestAnimationFrame(() => bubble.classList.add('show'));

                setTimeout(() => {
                    if (msg.isLove) {
                        const cls = msg.lang === 'zh' ? 'love-text love-text-zh' : 'love-text';
                        bubble.innerHTML = `<div class="${cls}">${msg.text}</div>`;
                    } else {
                        bubble.innerHTML = msg.text;
                    }
                    const t = document.createElement('div');
                    t.className = 'chat-time';
                    const n = new Date();
                    t.textContent = String(n.getHours()).padStart(2,'0')+':'+String(n.getMinutes()).padStart(2,'0');
                    bubble.appendChild(t);

                    idx++;
                    setTimeout(next, 700);
                }, 1100);
            }
            next();
        }

        // ===== CONFETTI =====
        function createConfetti(count) {
            const cols = ['#ff6b9d','#e84393','#f8b500','#a29bfe','#fd79a8','#ff4757','#ffa502'];
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const el = document.createElement('div');
                    el.className = 'confetti';
                    el.style.left = Math.random()*100 + '%';
                    el.style.width = (Math.random()*10+5) + 'px';
                    el.style.height = (Math.random()*10+5) + 'px';
                    el.style.background = cols[Math.floor(Math.random()*cols.length)];
                    el.style.borderRadius = Math.random()>0.5?'50%':'2px';
                    document.body.appendChild(el);
                    const xD = (Math.random()-0.5)*300, spin = Math.random()*720-360;
                    const dur = (Math.random()*2.5+2)*1000;
                    el.animate([
                        { transform:'translateY(0) translateX(0) rotate(0) scale(0)', opacity:0 },
                        { opacity:1, offset:0.1 },
                        { transform:`translateY(${innerHeight+30}px) translateX(${xD}px) rotate(${spin}deg) scale(0.3)`, opacity:0 }
                    ], { duration:dur, easing:'cubic-bezier(.25,.46,.45,.94)' }).onfinish = () => el.remove();
                }, i*25);
            }
        }

    })();
    </script>
</body>
</html>
